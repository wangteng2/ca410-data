<!DOCTYPE html>
<html>
<head>
    <title>CA410测量数据</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .chart { width: 100%; height: 400px; margin: 20px 0; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        .data-table th { background-color: #f4f4f4; }
    </style>
</head>
<body>
    <div class="container">
        <h1>CA410测量数据可视化</h1>
        
        <!-- 图表容器 -->
        <div id="lvChart" class="chart"></div>
        
        <!-- 数据表格 -->
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th>时间</th>
                    <th>Lv (cd/m²)</th>
                    <th>sx</th>
                    <th>sy</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <script>
        // 从本地JSON文件加载数据
        fetch('measurements.json')
            .then(response => {
                console.log('响应状态:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP 错误! 状态: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('加载的数据:', data);
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('数据格式不正确或为空');
                }
                // 准备图表数据
                const timestamps = data.map(item => {
                    const [date, time] = item.timestamp.split(' ');
                    return {
                        value: item.timestamp,
                        label: {
                            formatter: [date, time].join('\n')
                        }
                    };
                });
                const lvValues = data.map(item => item.Lv);
                const sxValues = data.map(item => item.sx);
                const syValues = data.map(item => item.sy);

                // Lv和色度图表
                const lvChart = echarts.init(document.getElementById('lvChart'));
                const option = {
                    title: {
                        text: 'CA410测量结果趋势'
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            let result = params[0].name + '<br/>';
                            params.forEach(param => {
                                let value = param.value;
                                if(param.seriesName === 'Lv') {
                                    value = value.toFixed(2) + ' cd/m²';
                                } else {
                                    value = value.toFixed(4);
                                }
                                result += param.seriesName + ': ' + value + '<br/>';
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: ['Lv', 'sx', 'sy']
                    },
                    grid: {
                        right: '10%',
                        bottom: '15%'  // 增加底部空间以显示两行时间
                    },
                    xAxis: {
                        type: 'category',
                        data: timestamps.map(item => item.value),
                        axisLabel: {
                            rotate: 45,
                            formatter: function (value) {
                                const [date, time] = value.split(' ');
                                return date + '\n' + time;
                            },
                            interval: 0,
                            lineHeight: 14,
                            padding: [5, 0, 0, 0]
                        }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: 'Lv (cd/m²)',
                            position: 'left',
                            axisLine: {
                                show: true,
                                lineStyle: {
                                    color: '#5470C6'
                                }
                            }
                        },
                        {
                            type: 'value',
                            name: 'sx/sy',
                            position: 'right',
                            min: 0,
                            max: 1,
                            axisLine: {
                                show: true,
                                lineStyle: {
                                    color: '#91CC75'
                                }
                            }
                        }
                    ],
                    series: [
                        {
                            name: 'Lv',
                            type: 'line',
                            data: lvValues,
                            yAxisIndex: 0,
                            itemStyle: {
                                color: '#5470C6'
                            }
                        },
                        {
                            name: 'sx',
                            type: 'line',
                            data: sxValues,
                            yAxisIndex: 1,
                            itemStyle: {
                                color: '#91CC75'
                            }
                        },
                        {
                            name: 'sy',
                            type: 'line',
                            data: syValues,
                            yAxisIndex: 1,
                            itemStyle: {
                                color: '#FAC858'
                            }
                        }
                    ]
                };
                lvChart.setOption(option);

                // 填充表格
                const tableBody = document.getElementById('tableBody');
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.timestamp}</td>
                        <td>${item.Lv.toFixed(2)}</td>
                        <td>${item.sx.toFixed(4)}</td>
                        <td>${item.sy.toFixed(4)}</td>
                    `;
                    tableBody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('错误详情:', error);
                // 在页面上显示错误信息
                document.querySelector('.container').innerHTML += `
                    <div style="color: red; margin-top: 20px;">
                        数据加载失败: ${error.message}
                    </div>
                `;
            });
    </script>
</body>
</html>
