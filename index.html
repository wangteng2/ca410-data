<!DOCTYPE html>
<html>
<head>
    <title>CA410测量数据</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .chart { width: 100%; height: 400px; margin: 20px 0; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        .data-table th { background-color: #f4f4f4; }
        .refresh-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CA410测量数据可视化</h1>
        <button class="refresh-button" onclick="refreshData()">刷新数据</button>
        
        <div id="lvChart" class="chart"></div>
        
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th>时间</th>
                    <th>Lv (cd/m²)</th>
                    <th>sx</th>
                    <th>sy</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <script>
        let lvChart = null;

        function initChart() {
            if (lvChart) {
                lvChart.dispose();
            }
            lvChart = echarts.init(document.getElementById('lvChart'));
        }

        function loadData() {
            fetch('./measurements.json', {
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON解析错误:', e);
                        console.log('收到的原始数据:', text);
                        throw new Error('JSON解析失败: ' + e.message);
                    }
                });
            })
            .then(data => {
                if (!Array.isArray(data)) {
                    console.error('数据格式错误:', data);
                    throw new Error('数据格式错误: 预期是数组');
                }

                const validData = data.filter(item => 
                    item && 
                    item.Lv > 0 &&
                    item.sx > 0 &&
                    item.sy > 0
                );

                if (validData.length === 0) {
                    throw new Error('没有有效数据');
                }

                const uniqueData = Array.from(new Map(
                    validData.map(item => [item.timestamp, item])
                ).values());

                uniqueData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                const last30Data = uniqueData.slice(-30);

                const timestamps = last30Data.map(item => {
                    const [date, time] = item.timestamp.split(' ');
                    return {
                        value: item.timestamp,
                        label: {
                            formatter: [date, time].join('\n')
                        }
                    };
                });
                const lvValues = last30Data.map(item => item.Lv);
                const sxValues = last30Data.map(item => item.sx);
                const syValues = last30Data.map(item => item.sy);

                initChart();
                
                const option = {
                    animation: false,
                    title: {
                        text: 'CA410测量结果趋势'
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            let result = params[0].name + '<br/>';
                            params.forEach(param => {
                                let value = param.value;
                                if(param.seriesName === 'Lv') {
                                    value = value.toFixed(2) + ' cd/m²';
                                } else {
                                    value = value.toFixed(4);
                                }
                                result += param.seriesName + ': ' + value + '<br/>';
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: ['Lv', 'sx', 'sy']
                    },
                    xAxis: {
                        type: 'category',
                        data: timestamps,
                        axisLabel: {
                            rotate: 45,
                            formatter: function(value) {
                                return value.split(' ')[1];
                            }
                        }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: 'Lv (cd/m²)',
                            position: 'left'
                        },
                        {
                            type: 'value',
                            name: 'sx/sy',
                            position: 'right',
                            min: 0.3,
                            max: 0.4
                        }
                    ],
                    series: [
                        {
                            name: 'Lv',
                            type: 'line',
                            data: lvValues,
                            yAxisIndex: 0
                        },
                        {
                            name: 'sx',
                            type: 'line',
                            data: sxValues,
                            yAxisIndex: 1
                        },
                        {
                            name: 'sy',
                            type: 'line',
                            data: syValues,
                            yAxisIndex: 1
                        }
                    ]
                };
                lvChart.setOption(option);

                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                last30Data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.timestamp}</td>
                        <td>${item.Lv.toFixed(2)}</td>
                        <td>${item.sx.toFixed(4)}</td>
                        <td>${item.sy.toFixed(4)}</td>
                    `;
                    tableBody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('数据加载失败:', error);
                const errorDiv = document.createElement('div');
                errorDiv.style.color = 'red';
                errorDiv.style.marginTop = '20px';
                errorDiv.textContent = `数据加载失败: ${error.message}`;
                document.querySelector('.container').appendChild(errorDiv);
            });
        }

        function refreshData() {
            const errorDivs = document.querySelectorAll('.container div[style*="color: red"]');
            errorDivs.forEach(div => div.remove());
            loadData();
        }

        window.addEventListener('load', loadData);
    </script>
</body>
</html>
